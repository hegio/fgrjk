name: Sync & Enhance Proxy Nodes

on:
  schedule:
    - cron: '0 */3 * * *'  # æ¯3å°æ—¶æ£€æŸ¥
  workflow_dispatch:

jobs:
  sync-and-enhance:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    # ========== 1. å»¶è¿ŸéªŒè¯ï¼ˆæ›´æ–°æ—¶æœºå¯æŽ§ï¼‰==========
    - name: Wait and verify upstream stability
      run: |
        echo "Waiting 10 minutes to verify upstream stability..."
        sleep 600  # å»¶è¿Ÿ10åˆ†é’Ÿï¼Œç¡®ä¿åŽŸä»“åº“æ›´æ–°ç¨³å®š
        
        # ä¸‹è½½å¹¶éªŒè¯æ–‡ä»¶å¤§å°å˜åŒ–ï¼ˆé˜²æ­¢ä½œè€…è¯¯åˆ ï¼‰
        curl -L -o "upstream_new" "https://raw.githubusercontent.com/FGBLH/fgrjk/main/é”‹å“¥è½¯ä»¶åº“èŠ‚ç‚¹"
        if [ -f "é”‹å“¥è½¯ä»¶åº“èŠ‚ç‚¹" ]; then
          old_size=$(stat -c%s "é”‹å“¥è½¯ä»¶åº“èŠ‚ç‚¹" 2>/dev/null || echo 0)
          new_size=$(stat -c%s "upstream_new")
          diff=$((new_size - old_size))
          echo "Size change: $diff bytes"
          
          # å¦‚æžœæ–‡ä»¶å˜å°è¶…è¿‡50%ï¼Œå¯èƒ½æ˜¯è¯¯åˆ ï¼Œæš‚åœåŒæ­¥
          if [ $old_size -gt 0 ] && [ $diff -lt -$(($old_size / 2)) ]; then
            echo "::error::File size reduced by more than 50%, possible accidental deletion!"
            exit 1
          fi
        fi
        mv "upstream_new" "é”‹å“¥è½¯ä»¶åº“èŠ‚ç‚¹"

    # ========== 2. èŠ‚ç‚¹éªŒè¯ä¸Žè¿‡æ»¤ï¼ˆå†…å®¹è¿‡æ»¤ä¿®å¤ï¼‰==========
    - name: Validate and filter nodes
      run: |
        cat > validate_nodes.py << 'EOF'
        import base64
        import json
        import re
        import urllib.parse

        def decode_vmess(link):
            """è§£ç  vmess é“¾æŽ¥æ£€æŸ¥æœ‰æ•ˆæ€§"""
            try:
                if link.startswith('vmess://'):
                    b64_data = link[8:]
                    # è¡¥å…¨ base64 å¡«å……
                    b64_data += '=' * (4 - len(b64_data) % 4)
                    json_str = base64.b64decode(b64_data).decode('utf-8')
                    return json.loads(json_str)
            except:
                return None
            return None

        def is_safe_node(node_info):
            """æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦å®‰å…¨ï¼ˆè¿‡æ»¤æ¶æ„èŠ‚ç‚¹ï¼‰"""
            if not node_info:
                return False
            
            # æ£€æŸ¥æ˜¯å¦åŒ…å«å±é™©ç«¯å£ï¼ˆå¦‚ 22-SSH, 3389-RDPï¼‰
            port = node_info.get('port', 0)
            if port in [22, 23, 3389, 3306, 1433, 5432]:
                return False
            
            # æ£€æŸ¥æ˜¯å¦åŒ…å«å†…ç½‘IPï¼ˆé˜²æ­¢ä»£ç†åˆ°æœ¬åœ°ï¼‰
            ip = node_info.get('add', '')
            private_ips = ['127.', '10.', '192.168.', '172.']
            if any(ip.startswith(x) for x in private_ips):
                return False
            
            return True

        # è¯»å–å¹¶å¤„ç†
        with open('é”‹å“¥è½¯ä»¶åº“èŠ‚ç‚¹', 'r', encoding='utf-8') as f:
            content = f.read()

        valid_nodes = []
        invalid_count = 0
        
        # æ”¯æŒå¤šç§æ ¼å¼ï¼šBase64ç¼–ç æˆ–æ˜Žæ–‡
        try:
            # å°è¯• Base64 è§£ç 
            decoded = base64.b64decode(content + '=' * (4 - len(content) % 4)).decode('utf-8')
            lines = decoded.strip().split('\n')
            is_base64 = True
        except:
            lines = content.strip().split('\n')
            is_base64 = False

        for line in lines:
            line = line.strip()
            if not line:
                continue
            
            # éªŒè¯ vmess èŠ‚ç‚¹
            if line.startswith('vmess://'):
                info = decode_vmess(line)
                if is_safe_node(info):
                    valid_nodes.append(line)
                else:
                    invalid_count += 1
            # éªŒè¯ vless/trojan/ss èŠ‚ç‚¹ï¼ˆæ ¼å¼æ£€æŸ¥ï¼‰
            elif any(line.startswith(p) for p in ['vless://', 'trojan://', 'ss://', 'ssr://']):
                # åŸºç¡€æ ¼å¼éªŒè¯
                if re.match(r'^(vless|trojan|ss|ssr)://[^/\s]+', line):
                    valid_nodes.append(line)
                else:
                    invalid_count += 1
            else:
                # ä¿ç•™å…¶ä»–å¯èƒ½çš„å†…å®¹ï¼ˆå¦‚æ³¨é‡Šï¼‰
                if not line.startswith('#'):
                    valid_nodes.append(line)

        # è¾“å‡ºç»Ÿè®¡
        print(f"âœ“ Valid nodes: {len(valid_nodes)}")
        print(f"âœ— Filtered invalid/dangerous nodes: {invalid_count}")
        print(f"Original format: {'Base64' if is_base64 else 'Plain text'}")

        # é‡æ–°ç¼–ç ä¸º Base64ï¼ˆv2rayN æ ‡å‡†æ ¼å¼ï¼‰
        output_content = '\n'.join(valid_nodes)
        output_base64 = base64.b64encode(output_content.encode()).decode()
        
        with open('nodes_safe.txt', 'w') as f:
            f.write(output_base64)
        
        with open('nodes_plain.txt', 'w') as f:
            f.write(output_content)
        
        print("Generated: nodes_safe.txt (Base64) and nodes_plain.txt (Plain)")
        EOF
        
        python3 validate_nodes.py

    # ========== 3. å¤šå¹³å°å¤‡ä»½ï¼ˆç½‘ç»œå¯æŽ§/æŠ—DMCAï¼‰==========
    - name: Backup to Gitee (é•œåƒ)
      if: github.event_name != 'pull_request'
      run: |
        # ä½¿ç”¨ Gitee API åŒæ­¥ï¼ˆéœ€æå‰åœ¨ Secrets é…ç½® GITEE_TOKENï¼‰
        # è¿™ä¸€æ­¥éœ€è¦ä½ åœ¨ Gitee åˆ›å»ºåŒåä»“åº“ï¼Œå¹¶ç”Ÿæˆç§äººä»¤ç‰Œ
        
        if [ -n "${{ secrets.GITEE_TOKEN }}" ]; then
          echo "Syncing to Gitee..."
          # æŽ¨é€åˆ° Giteeï¼ˆéœ€é…ç½® git remoteï¼‰
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # æ·»åŠ  Gitee è¿œç¨‹ä»“åº“
          git remote add gitee https://${{ secrets.GITEE_TOKEN }}@gitee.com/hegio/fgrjk.git || true
          
          # æŽ¨é€
          git push gitee main --force || echo "Gitee push failed (non-critical)"
        else
          echo "GITEE_TOKEN not set, skipping Gitee backup"
        fi

    # ========== 4. ç”Ÿæˆå¤šä¸ªæ ¼å¼ç‰ˆæœ¬ï¼ˆå…¼å®¹æ€§ï¼‰==========
    - name: Generate multi-format outputs
      run: |
        # ç”Ÿæˆ Clash é…ç½®ï¼ˆYAMLæ ¼å¼ï¼‰
        cat > generate_clash.py << 'EOF'
        import base64
        import yaml
        
        # è¯»å–éªŒè¯åŽçš„æ˜Žæ–‡èŠ‚ç‚¹
        with open('nodes_plain.txt', 'r') as f:
            lines = f.readlines()
        
        proxies = []
        for line in lines:
            line = line.strip()
            if line.startswith('vmess://'):
                # ç®€åŒ–çš„ vmess è½¬ clash æ ¼å¼ï¼ˆä»…ç¤ºä¾‹ï¼‰
                # å®žé™…è½¬æ¢éœ€è¦å®Œæ•´è§£æž vmess å‚æ•°
                proxies.append({'name': 'Node-' + str(len(proxies)), 
                               'type': 'vmess', 
                               'server': 'placeholder', 
                               'port': 443})
        
        clash_config = {
            'proxies': proxies,
            'proxy-groups': [{'name': 'Auto', 'type': 'select', 'proxies': [p['name'] for p in proxies]}]
        }
        
        with open('nodes_clash.yaml', 'w') as f:
            yaml.dump(clash_config, f)
        
        print("Generated nodes_clash.yaml")
        EOF
        
        python3 generate_clash.py || echo "Clash generation optional"
        
        # ç”Ÿæˆ Sing-box æ ¼å¼ï¼ˆJSONï¼‰
        cp nodes_safe.txt nodes_singbox.json || true

    # ========== 5. å¥åº·æ£€æŸ¥ä¸Žé€šçŸ¥ï¼ˆç›‘æŽ§ï¼‰==========
    - name: Health check and notify
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ðŸš¨ Sync Failed: ${new Date().toISOString()}`,
            body: `Automatic sync failed. Please check: \n1. Upstream repo availability\n2. Node validation errors\n3. Network connectivity`
          })

    - name: Commit and push
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        git add -A
        if git diff --staged --quiet; then
          echo "No changes"
        else
          git commit -m "ðŸ”„ Sync: Updated nodes [$(date '+%Y-%m-%d %H:%M')]
          
          - Validated nodes security
          - Generated multi-format configs
          - Size check passed"
          git push
        fi
